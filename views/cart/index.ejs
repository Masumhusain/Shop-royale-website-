<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shopping Cart | Royal Footwear</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --primary-dark: #1a1a2e;
            --secondary-dark: #16213e;
            --accent-color: #ffd700;
            --light-bg: #f5f7fb;
        }
        
        body { background: var(--light-bg); font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        .cart-item-image {
            width: 100px;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn-gold {
            background: linear-gradient(135deg, var(--accent-color) 0%, #ffed4e 100%);
            color: var(--primary-dark);
            border: none;
            font-weight: 700;
            padding: 12px 30px;
            border-radius: 8px;
        }
        
        .btn-gold:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(255, 215, 0, 0.3); }
        
        .empty-cart {
            text-align: center;
            padding: 50px 20px;
        }
        
        .empty-cart-icon {
            font-size: 80px;
            color: #ddd;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">Home</a></li>
                <li class="breadcrumb-item"><a href="/products">Products</a></li>
                <li class="breadcrumb-item active" aria-current="page">Shopping Cart</li>
            </ol>
        </nav>
        
        <h1 class="mb-4">Shopping Cart</h1>
        
        <% if (!cart || !cart.items || cart.items.length === 0) { %>
            <!-- Empty Cart -->
            <div class="empty-cart">
                <div class="empty-cart-icon">
                    <i class="fas fa-shopping-cart"></i>
                </div>
                <h3 class="mb-3">Your cart is empty</h3>
                <p class="text-muted mb-4">Looks like you haven't added any items to your cart yet.</p>
                <a href="/products" class="btn btn-gold">Continue Shopping</a>
            </div>
        <% } else { %>
            <div class="row">
                <!-- Cart Items -->
                <div class="col-lg-8">
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th scope="col">Product</th>
                                            <th scope="col">Price</th>
                                            <th scope="col">Quantity</th>
                                            <th scope="col">Total</th>
                                            <th scope="col">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <% let subtotal = 0; %>
                                        <% cart.items.forEach((item, index) => { 
                                            const itemPrice = item.discountPrice || item.price;
                                            const itemTotal = itemPrice * item.quantity;
                                            subtotal += itemTotal;
                                        %>
                                            <tr id="cart-item-<%= item._id %>">
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <img src="<%= item.image?.secure_url || item.image?.url || '/images/default-shoe.jpg' %>" 
                                                             alt="<%= item.name %>" 
                                                             class="cart-item-image me-3">
                                                        <div>
                                                            <h6 class="mb-1"><%= item.name %></h6>
                                                            <p class="text-muted mb-1 small">
                                                                Size: <%= item.size %> | 
                                                                Color: <%= item.color?.name || item.color %>
                                                            </p>
                                                            <p class="text-muted mb-0 small"><%= item.brand %></p>
                                                        </div>
                                                    </div>
                                                </td>
                                                <td>
                                                    <% if (item.discountPrice && item.discountPrice < item.price) { %>
                                                        <div>
                                                            <span class="text-danger fw-bold">₹<%= item.discountPrice.toFixed(2) %></span>
                                                            <br>
                                                            <small class="text-muted text-decoration-line-through">₹<%= item.price.toFixed(2) %></small>
                                                        </div>
                                                    <% } else { %>
                                                        <span class="fw-bold">₹<%= item.price.toFixed(2) %></span>
                                                    <% } %>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center">
                                                        <button class="btn btn-outline-secondary btn-sm quantity-btn me-2"
                                                                onclick="updateQuantity('<%= item._id %>', -1)">
                                                            <i class="fas fa-minus"></i>
                                                        </button>
                                                        <span class="mx-2" id="quantity-<%= item._id %>"><%= item.quantity %></span>
                                                        <button class="btn btn-outline-secondary btn-sm quantity-btn ms-2"
                                                                onclick="updateQuantity('<%= item._id %>', 1)">
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </td>
                                                <td>
                                                    <span class="fw-bold" id="item-total-<%= item._id %>">
                                                        ₹<%= itemTotal.toFixed(2) %>
                                                    </span>
                                                </td>
                                                <td>
                                                    <button class="btn btn-outline-danger btn-sm" 
                                                            onclick="removeItem('<%= item._id %>')">
                                                        <i class="fas fa-trash"></i>
                                                    </button>
                                                </td>
                                            </tr>
                                        <% }); %>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Continue Shopping -->
                    <div class="d-flex justify-content-between">
                        <a href="/products" class="btn btn-outline-dark">
                            <i class="fas fa-arrow-left me-2"></i>Continue Shopping
                        </a>
                        <button class="btn btn-danger" onclick="clearCart()">
                            <i class="fas fa-trash me-2"></i>Clear Cart
                        </button>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div class="col-lg-4">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title mb-4">Order Summary</h5>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Subtotal</span>
                                <span class="fw-bold" id="cart-subtotal">₹<%= subtotal.toFixed(2) %></span>
                            </div>
                            
                            <div class="d-flex justify-content-between mb-2">
                                <span class="text-muted">Shipping</span>
                                <span class="fw-bold">FREE</span>
                            </div>
                            
                            <% 
                            let discount = 0;
                            if (cart.items) {
                                discount = cart.items.reduce((total, item) => {
                                    if (item.discountPrice && item.discountPrice < item.price) {
                                        return total + ((item.price - item.discountPrice) * item.quantity);
                                    }
                                    return total;
                                }, 0);
                            }
                            const total = subtotal - discount;
                            %>
                            
                            <% if (discount > 0) { %>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Discount</span>
                                    <span class="text-success fw-bold">-₹<%= discount.toFixed(2) %></span>
                                </div>
                            <% } %>
                            
                            <hr>
                            
                            <div class="d-flex justify-content-between mb-4">
                                <span class="fw-bold">Total</span>
                                <span class="fw-bold fs-5" id="cart-total">₹<%= total.toFixed(2) %></span>
                            </div>
                            
                            <div class="d-grid">
                                <a href="/checkout" class="btn btn-gold btn-lg">
                                    Proceed to Checkout
                                </a>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Promo Code (Optional) -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h6 class="card-title mb-3">Have a Promo Code?</h6>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Enter promo code">
                                <button class="btn btn-outline-dark">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
    
    <!-- Success Modal -->
    <div class="modal fade" id="successModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center py-4">
                    <div class="royal-icon mb-4 mx-auto" style="background: var(--accent-color);">
                        <i class="fas fa-check fa-2x"></i>
                    </div>
                    <h4 class="mb-3" id="modal-title"></h4>
                    <p class="text-muted mb-4" id="modal-message"></p>
                    <div class="d-grid gap-2">
                        <button class="btn btn-gold" data-bs-dismiss="modal">Continue Shopping</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    // Update quantity
    function updateQuantity(itemId, change) {
        const quantityElement = document.getElementById(`quantity-${itemId}`);
        let currentQuantity = parseInt(quantityElement.textContent);
        let newQuantity = currentQuantity + change;
        
        if (newQuantity < 1) newQuantity = 1;
        if (newQuantity > 10) newQuantity = 10;
        
        if (newQuantity !== currentQuantity) {
            fetch(`/products/cart/update/${itemId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                credentials: 'include',
                body: JSON.stringify({ quantity: newQuantity })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    quantityElement.textContent = newQuantity;
                    
                    // Update item total
                    const itemRow = document.getElementById(`cart-item-${itemId}`);
                    const priceElement = itemRow.querySelector('td:nth-child(2) .fw-bold');
                    const price = parseFloat(priceElement.textContent.replace('₹', ''));
                    const itemTotal = price * newQuantity;
                    
                    document.getElementById(`item-total-${itemId}`).textContent = `₹${itemTotal.toFixed(2)}`;
                    
                    // Update cart totals
                    document.getElementById('cart-subtotal').textContent = `₹${data.subtotal}`;
                    document.getElementById('cart-total').textContent = `₹${data.subtotal}`;
                    
                    // Update cart count in navbar
                    updateCartCount();
                    
                    showNotification('Quantity updated successfully', 'success');
                } else {
                    showNotification(data.error || 'Failed to update quantity', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Please try again.', 'error');
            });
        }
    }
    
    // Remove item
    function removeItem(itemId) {
        if (confirm('Are you sure you want to remove this item from your cart?')) {
            fetch(`/products/cart/remove/${itemId}`, {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Remove item row
                    document.getElementById(`cart-item-${itemId}`).remove();
                    
                    // Update cart totals
                    document.getElementById('cart-subtotal').textContent = `₹${data.subtotal}`;
                    document.getElementById('cart-total').textContent = `₹${data.subtotal}`;
                    
                    // Update cart count in navbar
                    updateCartCount();
                    
                    showNotification('Item removed from cart', 'success');
                    
                    // Check if cart is now empty
                    const itemCount = document.querySelectorAll('tbody tr').length;
                    if (itemCount === 0) {
                        location.reload(); // Reload to show empty cart
                    }
                } else {
                    showNotification(data.error || 'Failed to remove item', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Please try again.', 'error');
            });
        }
    }
    
    // Clear cart
    function clearCart() {
        if (confirm('Are you sure you want to clear your entire cart?')) {
            fetch('/products/cart/clear', {
                method: 'DELETE',
                credentials: 'include'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload(); // Reload page
                } else {
                    showNotification(data.error || 'Failed to clear cart', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showNotification('Network error. Please try again.', 'error');
            });
        }
    }
    
    // Show notification
    function showNotification(message, type = 'info') {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        alertDiv.style.cssText = `
            top: 20px;
            right: 20px;
            z-index: 9999;
            min-width: 300px;
        `;
        
        alertDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(alertDiv);
        
        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.remove();
            }
        }, 5000);
    }
    
    // Update cart count in navbar
    function updateCartCount() {
        fetch('/products/cart/count', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const cartBadges = document.querySelectorAll('.cart-count-badge');
                cartBadges.forEach(badge => {
                    if (data.count > 0) {
                        badge.textContent = data.count;
                        badge.style.display = 'flex';
                    } else {
                        badge.style.display = 'none';
                    }
                });
            }
        })
        .catch(error => {
            console.error('Error updating cart count:', error);
        });
    }
    </script>
</body>
</html>